#!/bin/bash
# BARF - Build And Run Framework
# Issue-Driven Autonomous Development based on the Ralph Playbook

set -euo pipefail

# ============================================================================
# Constants
# ============================================================================
VERSION="0.2.0"
CONFIG_FILE=".barf.yaml"
DEFAULT_ISSUES_DIR="./issues"
DEFAULT_PLANS_DIR="./plans"
DEFAULT_MAX_RETRIES=3
TEMPLATES_DIR="${BARF_TEMPLATES_DIR:-$HOME/.barf/templates}"
BARF_DATA_DIR=".barf"
STATS_FILE="$BARF_DATA_DIR/stats.json"

# Pricing per million tokens (as of 2024)
declare -A PRICING_INPUT=(
    ["opus"]="15.00"
    ["sonnet"]="3.00"
    ["haiku"]="0.25"
)
declare -A PRICING_OUTPUT=(
    ["opus"]="75.00"
    ["sonnet"]="15.00"
    ["haiku"]="1.25"
)

# Approximate token limits per model (conservative estimates)
TOKEN_LIMIT_HAIKU=180000
TOKEN_LIMIT_SONNET=180000
TOKEN_LIMIT_OPUS=180000
CHARS_PER_TOKEN=4  # Rough estimate

# Global CLI flags
VERBOSE=0
QUIET=0
DRY_RUN=0
PARALLEL=0
CLI_MODEL=""

# ============================================================================
# Determine script directory for sourcing modules
# ============================================================================
BARF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ============================================================================
# Source library modules
# ============================================================================
source "$BARF_DIR/lib/logging.sh"
source "$BARF_DIR/lib/utils.sh"
source "$BARF_DIR/lib/config.sh"
source "$BARF_DIR/lib/testing.sh"
source "$BARF_DIR/lib/context.sh"
source "$BARF_DIR/lib/git.sh"
source "$BARF_DIR/lib/models.sh"
source "$BARF_DIR/lib/plugins.sh"
source "$BARF_DIR/lib/stats.sh"
source "$BARF_DIR/lib/plan-diff.sh"

# ============================================================================
# Source command modules
# ============================================================================
source "$BARF_DIR/cmd/help.sh"
source "$BARF_DIR/cmd/init.sh"
source "$BARF_DIR/cmd/interview.sh"
source "$BARF_DIR/cmd/plan.sh"
source "$BARF_DIR/cmd/build.sh"
source "$BARF_DIR/cmd/resume.sh"
source "$BARF_DIR/cmd/list.sh"
source "$BARF_DIR/cmd/status.sh"
source "$BARF_DIR/cmd/audit.sh"
source "$BARF_DIR/cmd/auto-split.sh"
source "$BARF_DIR/cmd/new.sh"
source "$BARF_DIR/cmd/dashboard.sh"

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    local command=""
    local args=()

    # Parse global options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            --version)
                show_version
                exit 0
                ;;
            -m|--model)
                if [[ -z "${2:-}" ]]; then
                    log_error "--model requires an argument"
                    exit 1
                fi
                CLI_MODEL="$2"
                shift 2
                ;;
            -n|--dry-run)
                DRY_RUN=1
                shift
                ;;
            -v|--verbose)
                VERBOSE=$((VERBOSE + 1))
                shift
                ;;
            -vv)
                VERBOSE=2
                shift
                ;;
            -q|--quiet)
                QUIET=1
                # Disable colors in quiet mode
                RED='' GREEN='' YELLOW='' BLUE='' MAGENTA='' CYAN='' BOLD='' DIM='' NC=''
                shift
                ;;
            -p|--parallel)
                PARALLEL=1
                shift
                ;;
            -*)
                log_error "Unknown option: $1"
                echo "Use 'barf --help' for usage information"
                exit 1
                ;;
            *)
                # First non-option is the command
                if [[ -z "$command" ]]; then
                    command="$1"
                else
                    args+=("$1")
                fi
                shift
                ;;
        esac
    done

    # Handle empty command
    if [[ -z "$command" ]]; then
        show_help
        exit 0
    fi

    # Debug output
    log_debug "Command: $command"
    log_debug "Args: ${args[*]:-}"
    log_debug "DRY_RUN=$DRY_RUN VERBOSE=$VERBOSE QUIET=$QUIET PARALLEL=$PARALLEL CLI_MODEL=$CLI_MODEL"

    # Route to command handlers
    case "$command" in
        init)
            cmd_init "${args[@]:-}"
            ;;
        interview)
            cmd_interview "${args[@]:-}"
            ;;
        plan)
            cmd_plan "${args[@]:-}"
            ;;
        build)
            cmd_build "${args[@]:-}"
            ;;
        resume)
            cmd_resume "${args[@]:-}"
            ;;
        audit)
            cmd_audit "${args[@]:-}"
            ;;
        stats)
            cmd_stats "${args[@]:-}"
            ;;
        list|ls)
            cmd_list "${args[@]:-}"
            ;;
        status|st)
            cmd_status "${args[@]:-}"
            ;;
        new)
            cmd_new "${args[@]:-}"
            ;;
        dashboard)
            cmd_dashboard
            ;;
        help)
            show_help
            ;;
        version)
            show_version
            ;;
        *)
            die "Unknown command: $command (use 'barf --help' for usage)"
            ;;
    esac
}

main "$@"
